!function(a){TransformRectangle=function(a,b,c,d){this.topLeft=new SimpleGeometry.Point,this.topRight=new SimpleGeometry.Point,this.bottomRight=new SimpleGeometry.Point,this.bottomLeft=new SimpleGeometry.Point,a&&this.updatePoints(a,b,c,d),this.triangleA=new SimpleGeometry.Triangle(this.topLeft,this.topRight,this.bottomLeft),this.triangleB=new SimpleGeometry.Triangle(this.bottomRight,this.bottomLeft,this.topRight),this.transform=new SimpleGeometry.Transform,this.imageTriangle=new SimpleGeometry.Triangle},TransformRectangle.prototype.updatePoints=function(a,b,c,d){this.topLeft.x=a.x,this.topLeft.y=a.y,this.topRight.x=b.x,this.topRight.y=b.y,this.bottomRight.x=c.x,this.bottomRight.y=c.y,this.bottomLeft.x=d.x,this.bottomLeft.y=d.y},TransformRectangle.prototype.updatePointsToTransformRectangle=function(a){this.updatePoints(a.topLeft,a.topRight,a.bottomRight,a.bottomLeft)},TransformRectangle.prototype.clone=function(){return new TransformRectangle(new SimpleGeometry.Point(this.topLeft.x,this.topLeft.y),new SimpleGeometry.Point(this.topRight.x,this.topRight.y),new SimpleGeometry.Point(this.bottomRight.x,this.bottomRight.y),new SimpleGeometry.Point(this.bottomLeft.x,this.bottomLeft.y))},TransformRectangle.prototype.render=function(a,b){b&&this.renderImage(a,b)},TransformRectangle.prototype.renderImage=function(a,b){SimpleGeometry.setIdentityMatrixToContext(a),a.fillStyle=a.createPattern(b,"no-repeat"),this.imageTriangle.a.x=this.imageTriangle.a.y=this.imageTriangle.b.y=this.imageTriangle.c.x=0,this.imageTriangle.b.x=b.width,this.imageTriangle.c.y=b.height,this.updateTriangleTransform(this.imageTriangle,this.triangleA),this.transform.tx=this.triangleA.a.x,this.transform.ty=this.triangleA.a.y,a.setTransform(this.transform.scaleX,this.transform.skewX,this.transform.skewY,this.transform.scaleY,this.transform.tx,this.transform.ty),a.beginPath(),a.moveTo(0,0),a.lineTo(b.width,0),a.lineTo(0,b.height),a.moveTo(0,0),a.fill(),a.closePath(),SimpleGeometry.setIdentityMatrixToContext(a),this.imageTriangle.b.x=this.imageTriangle.c.y=0,this.imageTriangle.a.x=this.imageTriangle.c.x=b.width,this.imageTriangle.a.y=b.height,this.imageTriangle.b.y=b.height,this.updateTriangleTransform(this.imageTriangle,this.triangleB),this.transform.ty=this.triangleA.a.y+2*(this.triangleA.b.y-this.triangleA.a.y),a.setTransform(this.transform.scaleX,this.transform.skewX,this.transform.skewY,this.transform.scaleY,this.transform.tx,this.transform.ty),a.beginPath(),a.moveTo(b.width,b.height),a.lineTo(0,b.height),a.lineTo(0,b.height-1),a.lineTo(b.width-1,0),a.lineTo(b.width,0),a.lineTo(b.width,b.height),a.fill(),a.closePath(),SimpleGeometry.setIdentityMatrixToContext(a)},TransformRectangle.prototype.updateTriangleTransform=function(a,b){var c=SimpleGeometry.angleBetweenTwoPoints(b.b,b.a),d=SimpleGeometry.angleBetweenTwoPoints(b.c,b.a),e=SimpleGeometry.distanceBetweenTwoPoints(b.a,b.b),f=SimpleGeometry.distanceBetweenTwoPoints(b.a,b.c),g=e/(a.b.x-a.a.x),h=f/(a.c.y-a.a.y);this.transform.scaleX=Math.cos(c)*g,this.transform.scaleY=Math.sin(d)*h,this.transform.skewX=Math.sin(c)*g,this.transform.skewY=Math.cos(d)*h},TransformRectangle.prototype.renderOutline=function(a){a.strokeStyle="#FF0000",a.lineWidth=1,a.beginPath(),a.moveTo(this.triangleA.a.x,this.triangleA.a.y),a.lineTo(this.triangleA.b.x,this.triangleA.b.y),a.lineTo(this.triangleA.c.x,this.triangleA.c.y),a.lineTo(this.triangleA.a.x,this.triangleA.a.y),a.stroke(),a.closePath(),a.beginPath(),a.moveTo(this.triangleB.a.x,this.triangleB.a.y),a.lineTo(this.triangleB.b.x,this.triangleB.b.y),a.lineTo(this.triangleB.c.x,this.triangleB.c.y),a.lineTo(this.triangleB.a.x,this.triangleB.a.y),a.stroke(),a.closePath()},a.TransformRectangle=TransformRectangle}(window);