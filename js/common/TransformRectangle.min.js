(function(a){TransformRectangle=function(e,d,c,b){this.topLeft=new SimpleGeometry.Point();this.topRight=new SimpleGeometry.Point();this.bottomRight=new SimpleGeometry.Point();this.bottomLeft=new SimpleGeometry.Point();if(e){this.updatePoints(e,d,c,b)}this.triangleA=new SimpleGeometry.Triangle(this.topLeft,this.topRight,this.bottomLeft);this.triangleB=new SimpleGeometry.Triangle(this.bottomRight,this.bottomLeft,this.topRight);this.transform=new SimpleGeometry.Transform();this.imageTriangle=new SimpleGeometry.Triangle()};TransformRectangle.prototype.updatePoints=function(e,d,c,b){this.topLeft.x=e.x;this.topLeft.y=e.y;this.topRight.x=d.x;this.topRight.y=d.y;this.bottomRight.x=c.x;this.bottomRight.y=c.y;this.bottomLeft.x=b.x;this.bottomLeft.y=b.y};TransformRectangle.prototype.updatePointsToTransformRectangle=function(b){this.updatePoints(b.topLeft,b.topRight,b.bottomRight,b.bottomLeft)};TransformRectangle.prototype.clone=function(){return new TransformRectangle(new SimpleGeometry.Point(this.topLeft.x,this.topLeft.y),new SimpleGeometry.Point(this.topRight.x,this.topRight.y),new SimpleGeometry.Point(this.bottomRight.x,this.bottomRight.y),new SimpleGeometry.Point(this.bottomLeft.x,this.bottomLeft.y))};TransformRectangle.prototype.render=function(b,c){if(c){this.renderImage(b,c)}};TransformRectangle.prototype.renderImage=function(b,c){SimpleGeometry.setIdentityMatrixToContext(b);b.fillStyle=b.createPattern(c,"no-repeat");this.imageTriangle.a.x=this.imageTriangle.a.y=this.imageTriangle.b.y=this.imageTriangle.c.x=0;this.imageTriangle.b.x=c.width;this.imageTriangle.c.y=c.height;this.updateTriangleTransform(this.imageTriangle,this.triangleA);this.transform.tx=this.triangleA.a.x;this.transform.ty=this.triangleA.a.y;b.setTransform(this.transform.scaleX,this.transform.skewX,this.transform.skewY,this.transform.scaleY,this.transform.tx,this.transform.ty);b.beginPath();b.moveTo(0,0);b.lineTo(c.width,0);b.lineTo(0,c.height);b.moveTo(0,0);b.fill();b.closePath();SimpleGeometry.setIdentityMatrixToContext(b);this.imageTriangle.b.x=this.imageTriangle.c.y=0;this.imageTriangle.a.x=this.imageTriangle.c.x=c.width;this.imageTriangle.a.y=c.height;this.imageTriangle.b.y=c.height;this.updateTriangleTransform(this.imageTriangle,this.triangleB);this.transform.ty=this.triangleA.a.y+(this.triangleA.b.y-this.triangleA.a.y)*2;b.setTransform(this.transform.scaleX,this.transform.skewX,this.transform.skewY,this.transform.scaleY,this.transform.tx,this.transform.ty);b.beginPath();b.moveTo(c.width,c.height);b.lineTo(0,c.height);b.lineTo(0,c.height-1);b.lineTo(c.width-1,0);b.lineTo(c.width,0);b.lineTo(c.width,c.height);b.fill();b.closePath();SimpleGeometry.setIdentityMatrixToContext(b)};TransformRectangle.prototype.updateTriangleTransform=function(b,i){var g=SimpleGeometry.angleBetweenTwoPoints(i.b,i.a);var d=SimpleGeometry.angleBetweenTwoPoints(i.c,i.a);var f=SimpleGeometry.distanceBetweenTwoPoints(i.a,i.b);var h=SimpleGeometry.distanceBetweenTwoPoints(i.a,i.c);var e=f/(b.b.x-b.a.x);var c=h/(b.c.y-b.a.y);this.transform.scaleX=Math.cos(g)*e;this.transform.scaleY=Math.sin(d)*c;this.transform.skewX=Math.sin(g)*e;this.transform.skewY=Math.cos(d)*c};TransformRectangle.prototype.renderOutline=function(b){b.strokeStyle="#FF0000";b.lineWidth=1;b.beginPath();b.moveTo(this.triangleA.a.x,this.triangleA.a.y);b.lineTo(this.triangleA.b.x,this.triangleA.b.y);b.lineTo(this.triangleA.c.x,this.triangleA.c.y);b.lineTo(this.triangleA.a.x,this.triangleA.a.y);b.stroke();b.closePath();b.beginPath();b.moveTo(this.triangleB.a.x,this.triangleB.a.y);b.lineTo(this.triangleB.b.x,this.triangleB.b.y);b.lineTo(this.triangleB.c.x,this.triangleB.c.y);b.lineTo(this.triangleB.a.x,this.triangleB.a.y);b.stroke();b.closePath()};a.TransformRectangle=TransformRectangle}(window));